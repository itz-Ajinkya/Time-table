<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COEP Admin Portal - Fixed</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --text-color: #333;
            --card-bg: #fff;
            --border-color: #ddd;
            --primary: #007bff;
            --accent: #6c757d;
            --danger: #dc3545;
            --success: #28a745;
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --primary: #bb86fc;
            --accent: #03dac6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 { margin: 0; }

        button {
            cursor: pointer;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: var(--primary);
            color: #fff;
            font-size: 14px;
            transition: opacity 0.2s;
            margin-right: 5px;
        }

        button:hover { opacity: 0.9; }
        button.secondary { background-color: var(--accent); }
        button.danger { background-color: var(--danger); }
        button.success { background-color: var(--success); }

        .toggle-btn {
            background: none;
            font-size: 24px;
            padding: 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        .tab.active {
            background-color: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .panel { display: none; }
        .panel.active { display: block; }

        /* Cards & Layout */
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .row { display: flex; gap: 10px; align-items: center;}
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
        }

        .note-item {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
        }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            font-size: 1.5rem; color: #fff; flex-direction: column;
            backdrop-filter: blur(5px);
        }

        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 3000;
            display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .login-box {
            background: var(--card-bg); padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); text-align: center;
            width: 90%; max-width: 400px; border: 1px solid var(--border-color);
        }
    </style>
</head>
<body class="dark-mode">

<div id="loading-overlay"><div>⏳ Processing...</div></div>

<div id="login-screen">
    <div class="login-box">
        <h2>Admin Login</h2>
        <p>Enter GitHub Personal Access Token (Classic)</p>
        <input type="password" id="gh-token-input" placeholder="ghp_..." style="margin-bottom: 15px;">
        <button onclick="saveTokenAndLogin()">Login</button>
    </div>
</div>

<div id="admin-interface" style="display:none;">
    <header>
        <h1>COEP Admin Portal</h1>
        <div>
            <button onclick="logout()" class="danger">Logout</button>
            <button class="toggle-btn" onclick="toggleDarkMode()">☀️</button>
        </div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="showPanel('students')">Students</div>
        <div class="tab" onclick="showPanel('schedule')">Schedule Logic</div>
        <div class="tab" onclick="showPanel('notes')">Notes</div>
    </div>

    <div id="students" class="panel active">
        <div class="card">
            <h3>Student Search</h3>
            <div class="row">
                <input type="text" id="mis-input" placeholder="Enter MIS (e.g. 112203050)" onkeydown="if(event.key==='Enter') fetchStudent()">
                <button onclick="fetchStudent()">Search</button>
            </div>
        </div>

        <div id="student-editor" class="card" style="display:none;">
            <h3>Edit Student Info: <span id="display-mis"></span></h3>
            <label>Full Name</label>
            <input type="text" id="edit-name">
            
            <h4>Subject Allocation</h4>
            <div id="cards-container"></div>
            
            <button onclick="addEmptyCard()" class="secondary" style="margin-bottom: 15px;">+ Add Subject</button>
            
            <div class="row">
                <button onclick="saveStudentChanges()" class="success">Save Changes to GitHub</button>
                <button class="secondary" onclick="document.getElementById('student-editor').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <div id="schedule" class="panel">
        <div class="card">
            <h3>View Schedule Structure</h3>
            <p>Select criteria to view raw JSON structure (Editing simplified for safety).</p>
            <div class="row">
                <select id="sched-sub" onchange="onSchedSubChange()"><option value="">Select Subject</option></select>
                <select id="sched-div"><option value="">Select Division</option></select>
                <button onclick="viewScheduleData()">View Data</button>
            </div>
            <textarea id="schedule-json-viewer" readonly></textarea>
        </div>
    </div>

    <div id="notes" class="panel">
        <div class="card">
            <h3>Website Notes</h3>
            <p>Notes appear at the bottom of student dashboards.</p>
            <div id="notes-list"></div>
            <div class="row" style="margin-top: 15px;">
                <input type="text" id="new-note-text" placeholder="Enter new note text..." style="margin-bottom:0;">
                <button onclick="addNote()">Add Note</button>
            </div>
            <br>
            <button onclick="saveLogicChanges()" class="success">Save Notes to GitHub</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const REPO_OWNER = "itz-ajinkya";
    const REPO_NAME = "Time-table";
    const BRANCH = "main";
    
    // --- STATE ---
    let DATA = { students: {}, schedule: {}, subjects: {}, notes: [] };
    let GH_TOKEN = localStorage.getItem("gh_token");
    let SHA_STUDENTS = null;
    let SHA_LOGIC = null;
    let EDIT_MIS = null;

    // --- INIT & AUTH ---
    window.onload = function() {
        if(GH_TOKEN) {
            loadData();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
    }

    function saveTokenAndLogin() {
        const t = document.getElementById('gh-token-input').value.trim();
        if(!t) return alert("Token required");
        localStorage.setItem("gh_token", t);
        GH_TOKEN = t;
        document.getElementById('login-screen').style.display = 'none';
        loadData();
    }

    function logout() {
        localStorage.removeItem("gh_token");
        location.reload();
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
    }

    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector(`.tab[onclick="showPanel('${id}')"]`).classList.add('active');
    }

    // --- GITHUB API ---
    async function ghRequest(path, method = 'GET', body = null) {
        const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;
        const headers = { 
            "Authorization": `token ${GH_TOKEN}`,
            "Accept": "application/vnd.github.v3+json",
            "Content-Type": "application/json"
        };
        const options = { method, headers };
        if (method === 'GET') options.url = url + `?ref=${BRANCH}`;
        if (body) options.body = JSON.stringify(body);

        const res = await fetch(url + (method === 'GET' ? `?ref=${BRANCH}` : ''), options);
        if (!res.ok) {
            if (res.status === 401) { logout(); throw new Error("Unauthorized"); }
            throw new Error(await res.text());
        }
        return res.json();
    }

    async function ghSaveFile(path, content, sha, message) {
        // UTF-8 Safe Encoding
        const contentBase64 = btoa(unescape(encodeURIComponent(content)));
        const body = { message, content: contentBase64, sha, branch: BRANCH };
        return ghRequest(path, 'PUT', body);
    }

    // --- DATA LOADING (THE FIX) ---
    async function loadData() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            document.getElementById('admin-interface').style.display = 'block';

            // 1. Load Students.js
            const sData = await ghRequest('students.js');
            SHA_STUDENTS = sData.sha;
            const sText = decodeURIComponent(escape(atob(sData.content)));
            
            // FIX: Use looser regex and Function constructor instead of JSON.parse
            const sMatch = sText.match(/GENERATED_DB\s*=\s*([\s\S]*?);?\s*$/m);
            if(sMatch) {
                // This handles keys without quotes and trailing commas safely
                DATA.students = new Function(`return ${sMatch[1]}`)();
            } else {
                throw new Error("Could not parse GENERATED_DB from students.js");
            }

            // 2. Load Logic.js
            const lData = await ghRequest('logic.js');
            SHA_LOGIC = lData.sha;
            const lText = decodeURIComponent(escape(atob(lData.content)));

            const schedMatch = lText.match(/MASTER_SCHEDULE\s*=\s*([\s\S]*?);/m);
            DATA.schedule = schedMatch ? new Function(`return ${schedMatch[1]}`)() : {};

            const notesMatch = lText.match(/ACTIVE_NOTES\s*=\s*([\s\S]*?);/m);
            DATA.notes = notesMatch ? new Function(`return ${notesMatch[1]}`)() : [];

            // 3. Extract Subjects
            Object.values(DATA.students).forEach(std => {
                if(std.cards) std.cards.forEach(c => {
                    if(c.code) DATA.subjects[c.code] = c.name || c.code;
                });
            });

            console.log("Loaded Students:", Object.keys(DATA.students).length);
            populateSchedDropdowns();
            renderNotes();

        } catch (e) {
            alert("Error loading data: " + e.message);
            console.error(e);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    // --- STUDENT LOGIC ---
    function fetchStudent() {
        const mis = document.getElementById('mis-input').value.trim();
        console.log("Searching:", mis, "in keys:", Object.keys(DATA.students)); // Debugging
        
        if (!mis || !DATA.students[mis]) {
            alert("Student not found! Ensure MIS matches exactly.");
            return;
        }
        EDIT_MIS = mis;
        const student = DATA.students[mis];
        
        document.getElementById('display-mis').innerText = mis;
        document.getElementById('edit-name').value = student.name;
        renderEditorCards(student.cards || []);
        document.getElementById('student-editor').style.display = 'block';
    }

    function renderEditorCards(cards) {
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        cards.forEach(card => createCardRow(card));
    }

    function createCardRow(card = {code: '', div: '', batch: ''}) {
        const container = document.getElementById('cards-container');
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
            <select class="card-sub" style="flex:2; margin-bottom:0;" onchange="onCardSubChange(this)">
                <option value="" disabled>Select Subject</option>
                ${getSubjectOptions(card.code)}
            </select>
            <select class="card-div" style="flex:1; margin-bottom:0;" onchange="onCardDivChange(this)">
                <option value="${card.div}">${card.div || 'Div'}</option>
            </select>
            <select class="card-batch" style="flex:1; margin-bottom:0;">
                <option value="${card.batch}">${card.batch || 'Batch'}</option>
            </select>
            <button class="danger" style="width:auto; padding: 8px 12px; margin-bottom:0;" onclick="this.parentElement.remove()">X</button>
        `;
        container.appendChild(div);
        
        // Initialize dropdowns
        const subSel = div.querySelector('.card-sub');
        subSel.value = card.code;
        // Trigger updates to populate divs/batches correctly if data exists
        if(card.code) onCardSubChange(subSel, card.div, card.batch);
    }

    function getSubjectOptions(selected) {
        // Merge schedule subjects and student subjects to get a full list
        const allSubs = new Set([...Object.keys(DATA.schedule), ...Object.keys(DATA.subjects)]);
        let opts = '';
        allSubs.forEach(s => {
            opts += `<option value="${s}">${s}</option>`;
        });
        return opts;
    }

    function addEmptyCard() {
        createCardRow();
    }

    // --- DROPDOWN CASCADING LOGIC ---
    function onCardSubChange(subSel, targetDiv = null, targetBatch = null) {
        const row = subSel.parentElement;
        const divSel = row.querySelector('.card-div');
        const sub = subSel.value;
        
        divSel.innerHTML = '<option value="" disabled selected>Select Div</option>';
        
        if(DATA.schedule[sub]) {
            Object.keys(DATA.schedule[sub]).forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.text = d;
                if(d === targetDiv) opt.selected = true;
                divSel.add(opt);
            });
        } else {
            // Allow manual entry logic or fallback if subject has no schedule data
            const opt = document.createElement('option'); opt.value = targetDiv || "1"; opt.text = targetDiv || "1"; divSel.add(opt);
        }
        onCardDivChange(divSel, targetBatch);
    }

    function onCardDivChange(divSel, targetBatch = null) {
        const row = divSel.parentElement;
        const sub = row.querySelector('.card-sub').value;
        const batchSel = row.querySelector('.card-batch');
        const div = divSel.value;

        batchSel.innerHTML = '<option value="-" selected>-</option>'; // Default to no batch

        if(sub && div && DATA.schedule[sub] && DATA.schedule[sub][div]) {
            // Find keys in schedule that aren't times (simple heuristic) or just list common batches
            const possibleBatches = Object.keys(DATA.schedule[sub][div]).filter(k => k.length <= 3 && k !== "L" && k !== "P");
            
            possibleBatches.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b; opt.text = b;
                if(b === targetBatch) opt.selected = true;
                batchSel.add(opt);
            });
        }
    }

    // --- SAVE STUDENTS ---
    async function saveStudentChanges() {
        if(!EDIT_MIS) return;
        document.getElementById('loading-overlay').style.display = 'flex';

        // 1. Construct Object
        const name = document.getElementById('edit-name').value;
        const cardRows = document.querySelectorAll('#cards-container .row');
        const newCards = [];

        cardRows.forEach(row => {
            const sub = row.querySelector('.card-sub').value;
            const div = row.querySelector('.card-div').value;
            const batch = row.querySelector('.card-batch').value;
            if(sub) {
                newCards.push({
                    code: sub,
                    name: DATA.subjects[sub] || sub, // Preserve name if known
                    div: div,
                    batch: batch
                });
            }
        });

        // 2. Update Local Data
        DATA.students[EDIT_MIS].name = name;
        DATA.students[EDIT_MIS].cards = newCards;

        // 3. Stringify to JS File Format
        const fileContent = `const GENERATED_DB = ${JSON.stringify(DATA.students, null, 4)};`;

        try {
            const res = await ghSaveFile('students.js', fileContent, SHA_STUDENTS, `Update student ${EDIT_MIS}`);
            SHA_STUDENTS = res.content.sha; // Update SHA for next save
            alert("Saved successfully!");
        } catch (e) {
            alert("Save failed: " + e.message);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    // --- SCHEDULE VIEWER ---
    function populateSchedDropdowns() {
        const subSel = document.getElementById('sched-sub');
        subSel.innerHTML = '<option value="">Select Subject</option>';
        Object.keys(DATA.schedule).forEach(k => {
            const opt = document.createElement('option'); opt.value = k; opt.text = k; subSel.add(opt);
        });
    }

    function onSchedSubChange() {
        const sub = document.getElementById('sched-sub').value;
        const divSel = document.getElementById('sched-div');
        divSel.innerHTML = '<option value="">Select Division</option>';
        if(sub && DATA.schedule[sub]) {
            Object.keys(DATA.schedule[sub]).forEach(d => {
                const opt = document.createElement('option'); opt.value = d; opt.text = d; divSel.add(opt);
            });
        }
    }

    function viewScheduleData() {
        const sub = document.getElementById('sched-sub').value;
        const div = document.getElementById('sched-div').value;
        if(sub && div) {
            document.getElementById('schedule-json-viewer').value = JSON.stringify(DATA.schedule[sub][div], null, 4);
        }
    }

    // --- NOTES LOGIC ---
    function renderNotes() {
        const list = document.getElementById('notes-list');
        list.innerHTML = '';
        DATA.notes.forEach((note, index) => {
            const div = document.createElement('div');
            div.className = 'note-item';
            div.innerHTML = `
                <span>${note}</span>
                <button class="danger" style="padding:4px 8px; font-size:12px;" onclick="removeNote(${index})">Delete</button>
            `;
            list.appendChild(div);
        });
    }

    function addNote() {
        const txt = document.getElementById('new-note-text').value.trim();
        if(txt) {
            DATA.notes.push(txt);
            document.getElementById('new-note-text').value = '';
            renderNotes();
        }
    }

    function removeNote(index) {
        DATA.notes.splice(index, 1);
        renderNotes();
    }

    // --- SAVE LOGIC (SCHEDULE + NOTES) ---
    async function saveLogicChanges() {
        document.getElementById('loading-overlay').style.display = 'flex';
        
        // We must save BOTH variables into logic.js
        const fileContent = `const MASTER_SCHEDULE = ${JSON.stringify(DATA.schedule, null, 4)};\n\nconst ACTIVE_NOTES = ${JSON.stringify(DATA.notes, null, 4)};`;

        try {
            const res = await ghSaveFile('logic.js', fileContent, SHA_LOGIC, `Update notes/logic`);
            SHA_LOGIC = res.content.sha;
            alert("Notes & Logic saved successfully!");
        } catch (e) {
            alert("Save failed: " + e.message);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }
</script>
</body>
</html>
