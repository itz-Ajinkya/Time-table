<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COEP Admin Portal (Debug Mode)</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --primary: #bb86fc; --danger: #cf6679; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: bold; border: none; cursor: pointer; }
        button.danger { background: var(--danger); color: #fff; }
        .row { display: flex; gap: 10px; }
        .hidden { display: none; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; flex-direction:column; z-index:999; }
        pre { background: #000; padding: 10px; overflow: auto; max-height: 200px; font-size: 12px; }
    </style>
</head>
<body>

<div id="loading"><h1>‚è≥ Working...</h1><div id="loading-msg"></div></div>

<div id="login-screen" class="card" style="max-width:400px; margin: 50px auto;">
    <h2>Admin Login</h2>
    <input type="password" id="gh-token" placeholder="Paste GitHub Token (ghp_...)">
    <button onclick="login()">Login</button>
</div>

<div id="app" class="hidden">
    <div class="row">
        <h2>COEP Admin</h2>
        <button onclick="logout()" class="danger" style="width:auto; margin-left:auto;">Logout</button>
    </div>

    <div class="card" style="border: 1px solid #bb86fc;">
        <h3>üõ†Ô∏è Diagnostics</h3>
        <p>If search fails, click below to see what is actually in the database.</p>
        <button onclick="debugCheckDB()">Check Database Data</button>
        <pre id="debug-output">No data checked yet.</pre>
    </div>

    <div class="card">
        <h3>Student Search</h3>
        <div class="row">
            <input type="text" id="search-input" placeholder="Enter MIS">
            <button onclick="searchStudent()">Search</button>
        </div>
    </div>

    <div id="editor" class="card hidden">
        <h3>Editing: <span id="lbl-mis"></span></h3>
        <label>Name</label> <input type="text" id="inp-name">
        <div id="course-list"></div>
        <button onclick="addCourseRow()">+ Add Subject</button>
        <div class="row" style="margin-top:15px;">
            <button onclick="saveChanges()">üíæ Save to GitHub</button>
            <button onclick="document.getElementById('editor').classList.add('hidden')" class="danger">Cancel</button>
        </div>
    </div>
</div>

<script>
const REPO_OWNER = "itz-ajinkya";
const REPO_NAME = "Time-table";
const BRANCH = "main";
let GH_TOKEN = localStorage.getItem("gh_token");
let DB = { students: {}, sha: null };

// --- INIT ---
if(GH_TOKEN) login();

function login() {
    const t = document.getElementById('gh-token').value || GH_TOKEN;
    if(!t) return;
    localStorage.setItem("gh_token", t);
    GH_TOKEN = t;
    document.getElementById('login-screen').classList.add('hidden');
    loadData();
}

function logout() {
    localStorage.removeItem("gh_token");
    location.reload();
}

// --- CORE: DATA LOADING ---
async function loadData() {
    showLoad(true, "Fetching students.js...");
    try {
        // 1. Fetch File
        const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/students.js?ref=${BRANCH}`;
        const res = await fetch(url, { headers: { Authorization: `token ${GH_TOKEN}` } });
        
        if(!res.ok) throw new Error((await res.json()).message || "Auth Failed");
        
        const data = await res.json();
        DB.sha = data.sha;
        const text = decodeURIComponent(escape(atob(data.content)));

        // 2. PARSE STRATEGY: "BRUTE FORCE JSON"
        // Ignore variable names. Just find the first { and last }.
        const firstBrace = text.indexOf('{');
        const lastBrace = text.lastIndexOf('}');

        if(firstBrace === -1 || lastBrace === -1) {
            alert("CRITICAL ERROR: No object {...} found in file.\n\nFile Start:\n" + text.substring(0, 100));
            throw new Error("Invalid File Format");
        }

        const jsonCandidate = text.substring(firstBrace, lastBrace + 1);

        try {
            // Try parsing securely
            DB.students = new Function('return ' + jsonCandidate)();
        } catch(e) {
            console.error(e);
            alert("Parsing Failed. The file content inside { ... } is not valid JS object.");
        }

        document.getElementById('app').classList.remove('hidden');
        showLoad(false);

    } catch (e) {
        showLoad(false);
        alert("Error: " + e.message);
        document.getElementById('login-screen').classList.remove('hidden');
    }
}

// --- DEBUGGING TOOL ---
function debugCheckDB() {
    const keys = Object.keys(DB.students);
    const count = keys.length;
    let msg = `Total Students: ${count}\n`;
    
    if(count > 0) {
        msg += `First 3 IDs found in DB:\n`;
        msg += `1. "${keys[0]}" (Type: ${typeof keys[0]})\n`;
        if(keys[1]) msg += `2. "${keys[1]}"\n`;
        if(keys[2]) msg += `3. "${keys[2]}"\n`;
    } else {
        msg += "‚ö†Ô∏è DATABASE IS EMPTY!";
    }
    document.getElementById('debug-output').innerText = msg;
}

// --- SEARCH LOGIC ---
function searchStudent() {
    const input = document.getElementById('search-input').value.trim();
    
    // Fuzzy Search: Compare string vs number
    const foundKey = Object.keys(DB.students).find(k => k == input); // '==' allows "123" == 123

    if (!foundKey) {
        alert(`Student "${input}" not found.\n(Click 'Check Database Data' to see valid IDs)`);
        return;
    }

    openEditor(foundKey);
}

// --- EDITOR LOGIC ---
let EDIT_ID = null;

function openEditor(id) {
    EDIT_ID = id;
    const s = DB.students[id];
    document.getElementById('lbl-mis').innerText = id;
    document.getElementById('inp-name').value = s.name || "";
    document.getElementById('course-list').innerHTML = '';
    
    (s.cards || []).forEach(addCourseRow);
    document.getElementById('editor').classList.remove('hidden');
}

function addCourseRow(data = {}) {
    const div = document.createElement('div');
    div.className = 'row';
    div.innerHTML = `
        <input placeholder="Subject (e.g. Dsa)" class="sub" value="${data.code || ''}">
        <input placeholder="Div" class="div" value="${data.div || ''}">
        <input placeholder="Batch" class="bat" value="${data.batch || ''}">
        <button class="danger" style="width:auto;" onclick="this.parentElement.remove()">X</button>
    `;
    document.getElementById('course-list').appendChild(div);
}

async function saveChanges() {
    showLoad(true, "Saving to GitHub...");
    
    // 1. Update Memory
    const name = document.getElementById('inp-name').value;
    const cards = [];
    document.querySelectorAll('#course-list .row').forEach(row => {
        cards.push({
            code: row.querySelector('.sub').value,
            div: row.querySelector('.div').value,
            batch: row.querySelector('.bat').value,
            name: row.querySelector('.sub').value // Auto-set name = code for now
        });
    });

    DB.students[EDIT_ID] = { name, cards };

    // 2. Construct File Content
    // We rebuild the file cleanly: "const GENERATED_DB = { ... }; export default GENERATED_DB;"
    const newContent = `const GENERATED_DB = ${JSON.stringify(DB.students, null, 4)};\n\nexport default GENERATED_DB;`;
    
    const body = {
        message: "Update " + EDIT_ID,
        content: btoa(unescape(encodeURIComponent(newContent))),
        sha: DB.sha,
        branch: BRANCH
    };

    try {
        const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/students.js`, {
            method: 'PUT',
            headers: { Authorization: `token ${GH_TOKEN}`, "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        
        if(!res.ok) throw new Error(await res.text());
        
        const json = await res.json();
        DB.sha = json.content.sha;
        alert("Saved Successfully!");
        document.getElementById('editor').classList.add('hidden');
    } catch(e) {
        alert("Save Failed: " + e.message);
    }
    showLoad(false);
}

function showLoad(show, msg) {
    const el = document.getElementById('loading');
    el.style.display = show ? 'flex' : 'none';
    if(msg) document.getElementById('loading-msg').innerText = msg;
}
</script>
</body>
</html>
